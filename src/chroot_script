#!/usr/bin/env bash
set -x
set -e
# OctoPI generation script
# Helper script that runs in a Raspbian chroot to create the OctoPI distro
# Written by Guy Sheffer <guysoft at gmail dot com>
# GPL V3

source /common.sh

unpack /filesystem/home/pi /home/pi pi
unpack /filesystem/home/root /root root
unpack /filesystem/boot /boot
apt-get update

apt-get remove -y --purge scratch squeak-plugins-scratch squeak-vm wolfram-engine python-minecraftpi minecraft-pi sonic-pi oracle-java8-jdk

#apt-get tools
apt-get -y --force-yes install python2.7 git screen checkinstall avahi-daemon libavahi-compat-libdnssd1 

pushd /home/pi

  #build virtualenv
  sudo -u pi virtualenv --system-site-packages oprint
  
  
  echo "--- Installing Chromium xdotool and matchbox-window-manager"
  apt-get install -y --force-yes chromium-browser xdotool matchbox-window-manager
  apt-get install vim

  
popd

#reach pi by name
echo "$OCTOPI_OVERRIDE_HOSTNAME" > /etc/hostname
sed -i -e "s@raspberrypi@$OCTOPI_OVERRIDE_HOSTNAME@g" /etc/hosts

#make sure users don't run git with sudo, thus breaking permissions, by adding /root/bin to the
#default sudo path and placing a git wrapper script there that checks if it's run as root
sed -i "s@secure_path=\"@secure_path=\"/root/bin:@g" /etc/sudoers
chmod +x /root/bin/git

# enable raspicam
echo "# enable raspicam" >> /boot/config.txt
echo "start_x=1" >> /boot/config.txt
echo "gpu_mem=128" >> /boot/config.txt

# allow network configuration via /boot/fullpageos-network.txt
sed -i "s@iface wlan0 @iface wlan0-raspbian @g" /etc/network/interfaces
sed -i "s@iface wlan1 @iface wlan1-raspbian @g" /etc/network/interfaces
echo "mapping wlan0" >> /etc/network/interfaces
echo "  script /root/bin/map_iface" >> /etc/network/interfaces
echo "mapping wlan1" >> /etc/network/interfaces
echo "  script /root/bin/map_iface" >> /etc/network/interfaces
echo "source /boot/fullpageos-network.txt" >> /etc/network/interfaces

#unpack root in the end, so etc file are not overwritten, might need to add two roots int he future
unpack /filesystem/root /


sed -i 's@exit 0@@' /etc/rc.local
echo "sudo -u pi X &" >> /etc/rc.local
echo "sudo -u pi /home/pi/scripts/run_onepageos &" >> /etc/rc.local
echo "exit 0" >> /etc/rc.local

#####################################################################
### setup services

#cleanup
apt-get clean
apt-get autoremove -y
